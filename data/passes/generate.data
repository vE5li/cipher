#functions { generate { format_float [ [ #single value [ float ] ] [ #single width [ integer ] ] #boolean [ #data #equals ] [ #scope:width ] [ #data 16 ] #if [ #data #true ] [ #last ] #string [ #data "" ] [ #scope:value ] #return [ #last ] #else #boolean [ #data #equals ] [ #scope:width ] [ #data 32 ] #if [ #data #true ] [ #last ] #string [ #data "" ] [ #scope:value ] #return [ #last ] #else #boolean [ #data #equals ] [ #scope:width ] [ #data 64 ] #if [ #data #true ] [ #last ] #string [ #scope:value ] [ #data "00000e+00" ] #return [ #last ] #else #boolean [ #data #equals ] [ #scope:width ] [ #data 128 ] #if [ #data #true ] [ #last ] #string [ #data "" ] [ #scope:value ] #return [ #last ] #end #end #end #end ] label_code [ [ #single label_lookup [ map ] ] #modify [ #data #scope:code ] [ #data "\n; labels\n" ] #iterate [ #scope:label_lookup ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #resolve [ #scope:entry:type:real_type ] #modify [ #data #scope:_0 ] [ #last ] #modify [ #data #scope:provider_type ] [ #scope:_0 ] #modify [ #data #scope:provider_name ] [ #scope:provider_type:mangled_name ] #boolean [ #data #string ] [ #scope:entry:value ] #if [ #data #true ] [ #last ] #modify [ #data #scope:item_code ] [ #data "" ] #length [ #scope:entry:value ] #modify [ #data #scope:_1 ] [ #last ] #modify [ #data #scope:string_length ] [ #scope:_1 ] #iterate [ #scope:entry:value ] #modify [ #data #scope:index ] [ #last:key ] [ #data #scope:character ] [ #last:value ] #integer [ #scope:character ] #modify [ #data #scope:_2 ] [ #last ] #string [ #scope:item_code ] [ #data "%type.main.Character " ] [ #scope:_2 ] #modify [ #data #scope:_3 ] [ #last ] #modify [ #data #scope:item_code ] [ #scope:_3 ] #boolean [ #data #smaller ] [ #scope:index ] [ #scope:string_length ] #if [ #data #true ] [ #last ] #string [ #scope:item_code ] [ #data ", " ] #modify [ #data #scope:_4 ] [ #last ] #modify [ #data #scope:item_code ] [ #scope:_4 ] #end #end #string [ #data "[" ] [ #scope:string_length ] [ #data " x %type.main.Character]" ] #modify [ #data #scope:_5 ] [ #last ] #modify [ #data #scope:array_identifier ] [ #scope:_5 ] #string [ #scope:code ] [ #scope:identifier ] [ #data "$constant = constant " ] [ #scope:array_identifier ] [ #data " [" ] [ #scope:item_code ] [ #data "]\n" ] #modify [ #data #scope:_6 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_6 ] #string [ #scope:code ] [ #scope:identifier ] [ #data "$pointer = constant %type.main.Character* getelementptr inbounds (" ] [ #scope:array_identifier ] [ #data ", " ] [ #scope:array_identifier ] [ #data "* " ] [ #scope:identifier ] [ #data "$constant, i32 0, i32 0)\n" ] #modify [ #data #scope:_7 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_7 ] #string [ #scope:code ] [ #scope:identifier ] [ #data " = constant " ] [ #scope:provider_name ] [ #data " { %type.main.Pointer_Character { i64 ptrtoint (%type.main.Character** " ] [ #scope:identifier ] [ #data "$pointer to i64) }, i64 " ] [ #scope:string_length ] [ #data ", i64 " ] [ #scope:string_length ] [ #data " }\n" ] #modify [ #data #scope:_8 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_8 ] #else #boolean [ #data #integer ] [ #scope:entry:value ] #if [ #data #true ] [ #last ] #string [ #scope:code ] [ #scope:identifier ] [ #data " = constant " ] [ #scope:provider_name ] [ #data " " ] [ #scope:entry:value ] [ #data "\n" ] #modify [ #data #scope:_9 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_9 ] #else #boolean [ #data #float ] [ #scope:entry:value ] #if [ #data #true ] [ #last ] #call [ #data generate:format_float ] [ #scope:entry:value ] [ #scope:provider_type:width ] #modify [ #data #scope:_10 ] [ #last ] #string [ #scope:code ] [ #scope:identifier ] [ #data " = constant " ] [ #scope:provider_name ] [ #data " " ] [ #scope:_10 ] [ #data "\n" ] #modify [ #data #scope:_11 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_11 ] #else #boolean [ #data #character ] [ #scope:entry:value ] #if [ #data #true ] [ #last ] #integer [ #scope:entry:value ] #modify [ #data #scope:_12 ] [ #last ] #string [ #scope:code ] [ #scope:identifier ] [ #data " = constant " ] [ #scope:provider_name ] [ #data " " ] [ #scope:_12 ] [ #data "\n" ] #modify [ #data #scope:_13 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_13 ] #else #boolean [ #data #boolean ] [ #scope:entry:value ] #if [ #data #true ] [ #last ] #string [ #scope:code ] [ #scope:identifier ] [ #data " = constant " ] [ #scope:provider_name ] [ #data " " ] [ #scope:entry:value ] [ #data "\n" ] #modify [ #data #scope:_14 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_14 ] #else #type [ #scope:entry:value ] #modify [ #data #scope:_15 ] [ #last ] #string [ #data "unhandled label value " ] [ #scope:_15 ] #modify [ #data #scope:_16 ] [ #last ] #error [ #scope:_16 ] #end #end #end #end #end #end #return [ #scope:code ] ] level [ [ #single namespace ] #modify [ #data #scope:types ] [ #data { } ] #modify [ #data #scope:labels ] [ #data { } ] #iterate [ #scope:namespace:types ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #boolean [ #data #not_equals ] [ #scope:entry:type ] [ #data integer ] #modify [ #data #scope:_0 ] [ #last ] #boolean [ #data #not_equals ] [ #scope:entry:type ] [ #data float ] #modify [ #data #scope:_1 ] [ #last ] #boolean [ #data #and ] [ #scope:_0 ] [ #scope:_1 ] #modify [ #data #scope:_2 ] [ #last ] #boolean [ #data #not_equals ] [ #scope:entry:type ] [ #data byte ] #modify [ #data #scope:_3 ] [ #last ] #boolean [ #data #and ] [ #scope:_2 ] [ #scope:_3 ] #if [ #data #true ] [ #last ] #insert [ #scope:types ] [ #scope:entry:mangled_name ] [ #scope:entry ] #modify [ #data #scope:_4 ] [ #last ] #modify [ #data #scope:types ] [ #scope:_4 ] #end #end #iterate [ #scope:namespace:labels ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #insert [ #scope:labels ] [ #scope:entry:mangled_name ] [ #scope:entry ] #modify [ #data #scope:_5 ] [ #last ] #modify [ #data #scope:labels ] [ #scope:_5 ] #end #iterate [ #scope:namespace:namespaces ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #call [ #data generate:level ] [ #scope:entry ] #modify [ #data #scope:_6 ] [ #last ] #modify [ #data #scope:namespace_entries ] [ #scope:_6 ] #merge [ #scope ] [ #scope:namespace_entries ] #modify [ #data #scope:_7 ] [ #last ] #modify [ #data #scope ] [ #scope:_7 ] #end #map [ #data types ] [ #scope:types ] [ #data labels ] [ #scope:labels ] #return [ #last ] ] mangle [ [ #single namespace [ map ] ] [ #single prefix [ string ] ] #iterate [ #scope:namespace:types ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #boolean [ #data #equals ] [ #scope:entry:type ] [ #data integer ] #if [ #data #true ] [ #last ] #string [ #data "i" ] [ #scope:entry:width ] #modify [ #data #scope:_0 ] [ #last ] #modify [ #data #scope:mangled_name ] [ #scope:_0 ] #else #boolean [ #data #equals ] [ #scope:entry:type ] [ #data float ] #if [ #data #true ] [ #last ] #call [ #data generate:mangle_float ] [ #scope:entry:width ] #modify [ #data #scope:_1 ] [ #last ] #modify [ #data #scope:mangled_name ] [ #scope:_1 ] #else #boolean [ #data #equals ] [ #scope:entry:type ] [ #data byte ] #if [ #data #true ] [ #last ] #modify [ #data #scope:mangled_name ] [ #data "i8" ] #else #boolean [ #data #equals ] [ #scope:entry:type ] [ #data alias ] #if [ #data #true ] [ #last ] #string [ #data "%type." ] [ #scope:prefix ] [ #scope:identifier ] #modify [ #data #scope:_2 ] [ #last ] #modify [ #data #scope:mangled_name ] [ #scope:_2 ] #else #boolean [ #data #equals ] [ #scope:entry:type ] [ #data structure ] #if [ #data #true ] [ #last ] #string [ #data "%type." ] [ #scope:prefix ] [ #scope:identifier ] #modify [ #data #scope:_3 ] [ #last ] #modify [ #data #scope:mangled_name ] [ #scope:_3 ] #end #end #end #end #end #string [ #data "mangled path for type " ] [ #scope:identifier ] [ #data " is " ] [ #scope:mangled_name ] #modify [ #data #scope:_4 ] [ #last ] #print_line [ #scope:_4 ] #path [ #data #scope:namespace:types ] [ #scope:identifier ] [ #data mangled_name ] #modify [ #data #scope:_5 ] [ #last ] #modify [ #data #scope:mangled_name_path ] [ #scope:_5 ] #modify [ #scope:mangled_name_path ] [ #scope:mangled_name ] #end #iterate [ #scope:namespace:labels ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #path [ #data #scope:namespace:labels ] [ #scope:identifier ] [ #data mangled_name ] #modify [ #data #scope:_6 ] [ #last ] #modify [ #data #scope:mangled_name_path ] [ #scope:_6 ] #string [ #data "@label." ] [ #scope:prefix ] [ #scope:identifier ] #modify [ #data #scope:_7 ] [ #last ] #modify [ #data #scope:mangled_name ] [ #scope:_7 ] #modify [ #scope:mangled_name_path ] [ #scope:mangled_name ] #end #iterate [ #scope:namespace:namespaces ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #string [ #scope:prefix ] [ #scope:identifier ] [ #data "." ] #modify [ #data #scope:_8 ] [ #last ] #modify [ #data #scope:new_prefix ] [ #scope:_8 ] #call [ #data generate:mangle ] [ #scope:entry ] [ #scope:new_prefix ] #modify [ #data #scope:_9 ] [ #last ] #modify [ #data #scope:new_entry ] [ #scope:_9 ] #overwrite [ #scope:namespace:namespaces ] [ #scope:identifier ] [ #scope:new_entry ] #modify [ #data #scope:_10 ] [ #last ] #modify [ #data #scope:namespace:namespaces ] [ #scope:_10 ] #end #return [ #scope:namespace ] ] mangle_float [ [ #single width [ integer ] ] #boolean [ #data #equals ] [ #scope:width ] [ #data 16 ] #if [ #data #true ] [ #last ] #return [ #data "short" ] #else #boolean [ #data #equals ] [ #scope:width ] [ #data 32 ] #if [ #data #true ] [ #last ] #return [ #data "float" ] #else #boolean [ #data #equals ] [ #scope:width ] [ #data 64 ] #if [ #data #true ] [ #last ] #return [ #data "double" ] #else #boolean [ #data #equals ] [ #scope:width ] [ #data 128 ] #if [ #data #true ] [ #last ] #return [ #data "fp128" ] #end #end #end #end ] top [ [ #single self ] #print_line [ #data "[ pass ] generate" ] #modify [ #data #scope:code ] [ #data "" ] #print_line [ #data "generating type names" ] #call [ #data generate:mangle ] [ #build:namespace ] [ #data "main." ] #modify [ #data #scope:_0 ] [ #last ] #modify [ #data #build:namespace ] [ #scope:_0 ] #call [ #data generate:level ] [ #build:namespace ] #modify [ #data #scope:_1 ] [ #last ] #modify [ #data #scope:leveled ] [ #scope:_1 ] #print_line [ #data "generating type data" ] #call [ #data generate:type_code ] [ #scope:leveled:types ] #modify [ #data #scope:_2 ] [ #last ] #string [ #scope:code ] [ #scope:_2 ] #modify [ #data #scope:_3 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_3 ] #print_line [ #data "generating label data" ] #call [ #data generate:label_code ] [ #scope:leveled:labels ] #modify [ #data #scope:_4 ] [ #last ] #string [ #scope:code ] [ #scope:_4 ] #modify [ #data #scope:_5 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_5 ] #string [ #scope:code ] [ #data "\n; temporary\n" ] #modify [ #data #scope:_6 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_6 ] #string [ #scope:code ] [ #data "@constant.run_message = constant [21 x i8] c\"Hello from Lugge%i!\\0A\\00\"\n" ] #modify [ #data #scope:_7 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_7 ] #string [ #scope:code ] [ #data "declare i32 @printf(i8*, ...)\n" ] #modify [ #data #scope:_8 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_8 ] #string [ #scope:code ] [ #data "\n; main\n" ] #modify [ #data #scope:_9 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_9 ] #string [ #scope:code ] [ #data "define i32 @main(i32 %argc, i8** %argv) {\n" ] #modify [ #data #scope:_10 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_10 ] #string [ #scope:code ] [ #data "    %temp = call i32 (i8*, ...) @printf(i8* getelementptr ([21 x i8], [21 x i8]* @constant.run_message, i64 0, i64 0), i64 ptrtoint (%type.main.Character** @label.main.test_string$pointer to i64))\n" ] #modify [ #data #scope:_11 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_11 ] #string [ #scope:code ] [ #data "    ret i32 0\n}\n" ] #modify [ #data #scope:_12 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_12 ] #modify [ #data #build:code ] [ #scope:code ] #return [ #scope:self ] ] type_code [ [ #single type_lookup [ map ] ] #modify [ #data #scope:code ] [ #data "\n; types\n" ] #iterate [ #scope:type_lookup ] #modify [ #data #scope:identifier ] [ #last:key ] [ #data #scope:entry ] [ #last:value ] #string [ #data "generating code for type " ] [ #scope:identifier ] #modify [ #data #scope:_0 ] [ #last ] #print_line [ #scope:_0 ] #boolean [ #data #equals ] [ #scope:entry:type ] [ #data alias ] #if [ #data #true ] [ #last ] #resolve [ #scope:entry:alias ] #modify [ #data #scope:_1 ] [ #last ] #modify [ #data #scope:provider_type ] [ #scope:_1 ] #string [ #scope:code ] [ #scope:identifier ] [ #data " = type " ] [ #scope:provider_type:mangled_name ] [ #data "\n" ] #modify [ #data #scope:_2 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_2 ] #else #boolean [ #data #equals ] [ #scope:entry:type ] [ #data structure ] #if [ #data #true ] [ #last ] #modify [ #data #scope:field_code ] [ #data " " ] #iterate [ #scope:entry:fields ] #modify [ #data #scope:index ] [ #last:key ] [ #data #scope:field ] [ #last:value ] #resolve [ #scope:field:real_type ] #modify [ #data #scope:_3 ] [ #last ] #modify [ #data #scope:provider_type ] [ #scope:_3 ] #string [ #scope:field_code ] [ #scope:provider_type:mangled_name ] #modify [ #data #scope:_4 ] [ #last ] #modify [ #data #scope:field_code ] [ #scope:_4 ] #boolean [ #data #not_equals ] [ #scope:field:instance_type ] [ #data real ] #if [ #data #true ] [ #last ] #string [ #scope:field_code ] [ #data "*" ] #modify [ #data #scope:_5 ] [ #last ] #modify [ #data #scope:field_code ] [ #scope:_5 ] #end #length [ #scope:entry:fields ] #modify [ #data #scope:_6 ] [ #last ] #boolean [ #data #smaller ] [ #scope:index ] [ #scope:_6 ] #if [ #data #true ] [ #last ] #string [ #scope:field_code ] [ #data ", " ] #modify [ #data #scope:_7 ] [ #last ] #modify [ #data #scope:field_code ] [ #scope:_7 ] #else #string [ #scope:field_code ] [ #data " " ] #modify [ #data #scope:_8 ] [ #last ] #modify [ #data #scope:field_code ] [ #scope:_8 ] #end #end #string [ #scope:code ] [ #scope:identifier ] [ #data " = type {" ] [ #scope:field_code ] [ #data "}\n" ] #modify [ #data #scope:_9 ] [ #last ] #modify [ #data #scope:code ] [ #scope:_9 ] #end #end #end #return [ #scope:code ] ] } } 